"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateProductsPrepareData = void 0;
async function updateProductsPrepareData({ container, context, data, }) {
    const ids = data.products.map((product) => product.id);
    const productHandleAddedChannelsMap = new Map();
    const productHandleRemovedChannelsMap = new Map();
    const productService = container.resolve("productService");
    const productServiceTx = productService.withTransaction(context.manager);
    const products = await productServiceTx.list(
    // TODO: use RemoteQuery - sales_channels needs to be added to the joiner config
    { id: ids }, {
        relations: [
            "variants",
            "variants.options",
            "images",
            "options",
            "tags",
            "collection",
            "sales_channels",
        ],
    });
    data.products.forEach((productInput) => {
        const removedChannels = [];
        const addedChannels = [];
        const currentProduct = products.find((p) => p.id === productInput.id);
        if (productInput.sales_channels) {
            productInput.sales_channels.forEach((channel) => {
                if (!currentProduct.sales_channels?.find((sc) => sc.id === channel.id)) {
                    addedChannels.push(channel.id);
                }
            });
            currentProduct.sales_channels?.forEach((channel) => {
                if (!productInput.sales_channels.find((sc) => sc.id === channel.id)) {
                    removedChannels.push(channel.id);
                }
            });
        }
        productHandleAddedChannelsMap.set(currentProduct.handle, addedChannels);
        productHandleRemovedChannelsMap.set(currentProduct.handle, removedChannels);
    });
    return {
        originalProducts: products,
        productHandleAddedChannelsMap,
        productHandleRemovedChannelsMap,
    };
}
exports.updateProductsPrepareData = updateProductsPrepareData;
updateProductsPrepareData.aliases = {
    preparedData: "preparedData",
};
//# sourceMappingURL=update-products-prepare-data.js.map